<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Quick Start</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/overview.html#content">总览</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-nodejs.html#content">Nodejs环境</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-browser.html#content">浏览器环境</a></li></ul></div><div class="nav-docs-section"><h3>Advanced Topics</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-basic-example-in-browser.html#content">在浏览器中直接上传文件到bos</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-security-issue.html#content">AK和SK的安全性问题</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-server-signature.html#content">服务端签名</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-sts.html#content">STS临时认证</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-multiupload.html#content">大文件分块上传</a></li><li><a style="margin-left:0;" class="active" href="/bce-sdk-js/docs/advanced-topics-resume.html#content">分块上传进阶 - “断点续传”</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-uploader.html#content">bce bos uploader</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-programming-style.html#content">多种异步编程风格</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-postobject.html#content">IE低版本的处理</a></li></ul></div><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-bos.html#content">BOS - api</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-vod.html#content">VOD - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>分块上传进阶 - “断点续传”</h1><div><p>在<a href="advanced-topics-multiupload.html" target="_blank">大文件分块上传</a>中，我们演示了如何使用文件分块上传，以提升应用的性能和稳定性。但用户在使用浏览器上传文件到BOS的时候，有可能会遇到页面关闭、浏览器崩溃、网络连接中断等问题，从面导致上传失败。如果用户上传失败了，似乎只能下次重新从头开始上传，这无疑是令人沮丧的，特别是当用户在上传大文件的时候。</p><p>在这篇文档中，我们将对<a href="advanced-topics-multiupload.html" target="_blank">大文件分块上传</a>文档中的示例程序进行一点改进，让它具备“断点上传”的能力。</p><h3><a class="anchor" name="%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"></a>实现原理 <a class="hash-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">#</a></h3><p>在我们使用文件分块上传（multipartUpload）的时候，BOS首先会为这个上传过程分配一个<code>uploadId</code>。然后我们将一个文件被分成了若干part，每个part独立上传，上传完成后，BOS 服务会为这个part生成一个<code>eTag</code>。当所有part都上传完成的时候，BOS 服务根据这些<code>eTag</code>和<code>uploadId</code>把正确的part找出来，并组合成原本的文件。</p><p>在这个过程中，BOS 并不需要所有的part一下子全部上传完毕，而是可以分多次进行。这也就是就，上传过程中，当页面意外关闭时，我们可以不必从头开始重新上传，而只需要把未上传成功的part的再次上传就可以。当然，前提是我们需要把此次上传的<code>uploadId</code>和上传完成的part的<code>etag</code>保存下来（不过，更推荐的做法是通过<a href="advanced-topics-multiupload.html#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E5%B7%B2%E4%B8%8A%E4%BC%A0%E7%9A%84%E5%9D%97%E4%BF%A1%E6%81%AF" target="_blank"><code>listParts</code></a>接口来查询更精确的已上传分块信息）。在上传一个part之前，可以先检查一下，这个part是否已经上传过了，如果以前已上传成功，那就直接跳过这个part的上传过程。</p><p>对于<code>uploadId</code>的存储，需要满足不受页面关闭的影响，比较理想的做法是存储在localStorage中。</p><h3><a class="anchor" name="%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8"></a>本地存储 <a class="hash-link" href="#%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8">#</a></h3><p>在保存<code>uploadId</code>时，我们需要为它指定一个key，让不同的文件、不同的上传过程区分开。本示例采用文件名、文件大小、分区大小、bucket名称、object名称组合成这个key：</p><pre class="prism language-javascript">
<span class="token keyword">var</span> generateLocalKey <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>blob<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>blob<span class="token punctuation">.</span>name<span class="token punctuation">,</span> blob<span class="token punctuation">.</span>size<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> object<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join<span class="token punctuation">(</span></span><span class="token string">&#x27;&amp;&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></pre><blockquote><p>注意：
用这个方式生成的key并不准确，如果两次上传过程中，选择了两个文件名相同、文件大小相同，但内容不同的文件，那么用这样的方式并不能正确区分这两个文件。更严谨的方式是根据文件名和文件内容计算MD5，并以此为key。</p></blockquote><p>存储方式我们选择localStorage：</p><pre class="prism language-javascript">
<span class="token keyword">var</span> getUploadId <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem<span class="token punctuation">(</span></span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> setUploadId <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> uploadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> localStorage<span class="token punctuation">.</span><span class="token function">setItem<span class="token punctuation">(</span></span>key<span class="token punctuation">,</span> uploadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> removeUploadId <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> localStorage<span class="token punctuation">.</span><span class="token function">removeItem<span class="token punctuation">(</span></span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></pre><h3><a class="anchor" name="%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0"></a>初始化分块上传 <a class="hash-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0">#</a></h3><p>在初始化分块上传时，有两种可能：</p><ul><li>如果已经存在此文件的<code>uploadId</code>，那么跳过<code>initiateMultipartUpload()</code>方法，改为调用<code>listParts()</code>来获取已上传分块信息；</li><li>如果没有此文件的<code>uploadId</code>，那么调用<code>initiateMultipartUpload()</code>方法获得新的<code>uploadId</code>，并将这个<code>uploadId</code>保存在localStorage中。</li></ul><pre class="prism language-javascript">
<span class="token comment" spellcheck="true">// ...省略BosClient初始化过程
</span><span class="token comment" spellcheck="true">// var bosClient = new BosClient(bosConfig);
</span>
<span class="token keyword">var</span> initiateMultipartUpload <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>file<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // 根据文件生成localStorage的key
</span>    <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token function">generateLocalKey<span class="token punctuation">(</span></span>file<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment" spellcheck="true"> // 获取对应的`uploadId`
</span>    <span class="token keyword">var</span> uploadId <span class="token operator">=</span> <span class="token function">getUploadId<span class="token punctuation">(</span></span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // `uploadId`存在，说明有未完成的分块上传。
</span>       <span class="token comment" spellcheck="true"> // 那么调用`listParts()`获取已上传分块信息。
</span>        <span class="token keyword">return</span> BosClient<span class="token punctuation">.</span><span class="token function">listParts<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> object<span class="token punctuation">,</span> uploadId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment" spellcheck="true"> // response.body.parts里包含了已上传分块的信息
</span>                response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>uploadId <span class="token operator">=</span> uploadId<span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // `uploadId`不存在，那么用正常的流程初始化
</span>        <span class="token keyword">return</span> BosClient<span class="token punctuation">.</span><span class="token function">initiateMultipartUpload<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> object<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment" spellcheck="true"> // response.body.uploadId为新生成的`uploadId`
</span>                response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

               <span class="token comment" spellcheck="true"> // 为了下次能使用断点续传，我们需要把新生成的`uploadId`保存下来
</span>                <span class="token function">setUploadId<span class="token punctuation">(</span></span>key<span class="token punctuation">,</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>uploadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><h3><a class="anchor" name="%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0"></a>分块上传 <a class="hash-link" href="#%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0">#</a></h3><p>在对大文件分割分块时，我们可以跟以上传的分块列表进行比较，以确定是否需要真的进行上传。</p><pre class="prism language-javascript">
<span class="token keyword">function</span> <span class="token function">getEtag<span class="token punctuation">(</span></span>partNumber<span class="token punctuation">,</span> parts<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // 从已上传part列表中找出特定partNumber的part的eTag
</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> parts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i &lt; l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>partNumber <span class="token operator">===</span> partNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>eTag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> getTasks <span class="token punctuation">(</span>file<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> object<span class="token punctuation">,</span> parts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> leftSize <span class="token operator">=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> partNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>leftSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> partSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min<span class="token punctuation">(</span></span>leftSize<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> task <span class="token operator">=</span> <span class="token punctuation">{</span>
            file<span class="token punctuation">:</span> file<span class="token punctuation">,</span>
            uploadId<span class="token punctuation">:</span> uploadId<span class="token punctuation">,</span>
            bucket<span class="token punctuation">:</span> bucket<span class="token punctuation">,</span>
            object<span class="token punctuation">:</span> object<span class="token punctuation">,</span>
            partNumber<span class="token punctuation">:</span> partNumber<span class="token punctuation">,</span>
            partSize<span class="token punctuation">:</span> partSize<span class="token punctuation">,</span>
            start<span class="token punctuation">:</span> offset<span class="token punctuation">,</span>
            stop<span class="token punctuation">:</span> offset <span class="token operator">+</span> partSize <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true"> // 如果在已上传完成的分块列表中找到这个分块的etag，那么记录下来
</span>        <span class="token keyword">var</span> etag <span class="token operator">=</span> <span class="token function">getEtag<span class="token punctuation">(</span></span>partNumber<span class="token punctuation">,</span> parts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>etag<span class="token punctuation">)</span><span class="token punctuation">{</span>
            task<span class="token punctuation">.</span>etag <span class="token operator">=</span> etag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        tasks<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        leftSize <span class="token operator">-</span><span class="token operator">=</span> partSize<span class="token punctuation">;</span>
        offset <span class="token operator">+</span><span class="token operator">=</span> partSize<span class="token punctuation">;</span>
        partNumber <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> tasks<span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>在进行分块上传处理的时候，根据是否已带有<code>etag</code>字段来决定是否需要上传：</p><pre class="prism language-javascript">
<span class="token keyword">function</span> <span class="token function">uploadPartFile<span class="token punctuation">(</span></span>state<span class="token punctuation">,</span> bosClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>etag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 如果有etag字段，则直接跳过上传
</span>            <span class="token function">callback<span class="token punctuation">(</span></span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                http_headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    etag<span class="token punctuation">:</span> task<span class="token punctuation">.</span>etag
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                body<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 否则进行上传
</span>            <span class="token keyword">var</span> blob <span class="token operator">=</span> task<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">slice<span class="token punctuation">(</span></span>task<span class="token punctuation">.</span>start<span class="token punctuation">,</span> task<span class="token punctuation">.</span>stop <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bosClient<span class="token punctuation">.</span><span class="token function">uploadPartFromBlob<span class="token punctuation">(</span></span>task<span class="token punctuation">.</span>bucketName<span class="token punctuation">,</span> task<span class="token punctuation">.</span>key<span class="token punctuation">,</span> task<span class="token punctuation">.</span>uploadId<span class="token punctuation">,</span> task<span class="token punctuation">.</span>partNumber<span class="token punctuation">,</span> task<span class="token punctuation">.</span>partSize<span class="token punctuation">,</span> blob<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token operator">++</span>state<span class="token punctuation">.</span>loaded<span class="token punctuation">;</span>
                    <span class="token function">callback<span class="token punctuation">(</span></span><span class="token keyword">null</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">callback<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><h3><a class="anchor" name="%E6%B5%81%E7%A8%8B%E4%BB%A3%E7%A0%81"></a>流程代码 <a class="hash-link" href="#%E6%B5%81%E7%A8%8B%E4%BB%A3%E7%A0%81">#</a></h3><p>我们对每个步骤的代码做了一些小修改，但整个流程的代码与分块上传很类似：</p><pre class="prism language-javascript">
<span class="token keyword">var</span> chunkSize <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 分块大小
</span><span class="token keyword">var</span> uploadId<span class="token punctuation">;</span>
<span class="token function">initiateMultipartUpload<span class="token punctuation">(</span></span>file<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> object<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uploadId <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>uploadId<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // uploadId，可能是服务器刚刚生成的，也可能是从localStorage获取的
</span>        <span class="token keyword">var</span> parts <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>parts <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 已上传的分块列表。如果是新上传，则为空数组
</span>
        <span class="token keyword">var</span> deferred <span class="token operator">=</span> sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">defer<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> tasks <span class="token operator">=</span> <span class="token function">getTasks<span class="token punctuation">(</span></span>blob<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> parts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
            lengthComputable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            loaded<span class="token punctuation">:</span> parts<span class="token punctuation">.</span>length<span class="token punctuation">,</span><span class="token comment" spellcheck="true"> // 已上传的分块数
</span>            total<span class="token punctuation">:</span> tasks<span class="token punctuation">.</span>length
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true"> // 如果已上传的分块数大于0，可以先修改一下文件上传进度
</span>        bosClient<span class="token punctuation">.</span><span class="token function">emit<span class="token punctuation">(</span></span><span class="token string">&#x27;progress&#x27;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true"> // 为了管理分块上传，使用了async（https://github.com/caolan/async）库来进行异步处理
</span>        <span class="token keyword">var</span> THREADS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 同时上传的分块数量
</span>        async<span class="token punctuation">.</span><span class="token function">mapLimit<span class="token punctuation">(</span></span>tasks<span class="token punctuation">,</span> THREADS<span class="token punctuation">,</span> <span class="token function">uploadPartFile<span class="token punctuation">(</span></span>state<span class="token punctuation">,</span> bosClient<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">reject<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> deferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>allResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> partList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        allResponse<span class="token punctuation">.</span><span class="token function">forEach<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 生成分块清单
</span>            partList<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
                partNumber<span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                eTag<span class="token punctuation">:</span> response<span class="token punctuation">.</span>http_headers<span class="token punctuation">.</span>etag
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true"> // 所有分块上传完成后，可以删除对应的`uploadId`了
</span>        <span class="token function">removeUploadId<span class="token punctuation">(</span></span>key<span class="token punctuation">,</span> uploadId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> bosClient<span class="token punctuation">.</span><span class="token function">completeMultipartUpload<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> partList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 完成上传
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传完成
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传失败，添加您的代码
</span>        console<span class="token punctuation">.</span><span class="token function">error<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-uploader.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>